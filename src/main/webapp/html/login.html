<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>欢迎登录</title>
    <link href="../css/login.css" rel="stylesheet">
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
</head>
<body>
<div id="loginDiv">
    <form action="http://localhost/users" method="post" id="loginForm">
        <h1>欢迎登录</h1>
        <p>学号<input id="stuId" name="stuId" type="text" onblur="checkStuId()">
            <span class="error" id="stuIdError" style="display: none">请输入正确的学号</span>
        </p>
        <p>密码<input id="password" name="password" type="password">
            <span class="error" id="passwordError" style="display: none">密码错误</span>
        </p>
    </form>
    <div id="subDiv">
        <input type="button" id = "signUp" class="button" value="登录" onclick="checkPassword()">
        <a href="register.html">点击注册</a>
    </div>
</div>

<script>
    let site = "https://zhangerfa.site";

    let canSignUp = false; // 当学号合规且未注册时为true
    // 学号验证
    checkStuId = function(){
        let stuId = document.getElementById("stuId").value.trim();
        let stuIdError = document.getElementById("stuIdError");
        if (isStuIdValid(stuId)){
            stuIdError.style.display = "none";
            // 判断学号是否注册
            axios.get(site + "/users/isExist?stuId=" + stuId).
            then(function(resp){
                let res = resp.data;
                if (res.data){
                    canSignUp = true;
                }else{
                    stuIdError.innerHTML = "学号未注册";
                    stuIdError.style.display = "";
                    canSignUp = false;
                }
            })
        }else{
            // 学号不符合规则
            stuIdError.innerHTML = "请输入正确的学号";
            stuIdError.style.display = "";
            canSignUp = false;
        }
    }

    isStuIdValid = function(stuId){
        let reg = /^[UM][0-9]{9}$/;
        return reg.test(stuId);
    }

    // 密码验证
    function checkPassword(){
        if (!canSignUp){
            alert("请输入正确的学号和密码");
        }else{
            let param = new URLSearchParams();
            param.append("stuId", document.getElementById("stuId").value.trim());
            param.append("password", document.getElementById("password").value.trim());
            axios.post(site + "/users/checkPassword", param).then(function (resp) {
                if (resp.data.data){
                    window.location = site + "/html/wall.html";
                }else{
                    document.getElementById("passwordError").style.display="";
                }
            })
        }
    }
</script>
</body>
</html>